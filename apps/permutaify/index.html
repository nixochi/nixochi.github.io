<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <title>BCC Permutahedron Voxelized Model (WebGL2 Optimized)</title>
  <style>
    /* CSS Variables - Dark mode only */
    :root {
      --bg-primary: #161617;
      --bg-secondary: #1c1c1e;
      --fg-primary: #f3f3f3;
      --fg-secondary: #b9b9b9;
      --border: #222224;
      --shadow: rgba(0,0,0,0.5);
      --backdrop-blur: rgba(28, 28, 30, 0.9);
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100vh;
      height: -webkit-fill-available;
      height: 100svh;
      overflow: hidden;
      touch-action: none;
      -ms-touch-action: none;
      -webkit-overflow-scrolling: touch;
    }

    body {
      background: var(--bg-primary);
      color: var(--fg-primary);
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    canvas {
      display: block;
      width: 100vw;
      width: -webkit-fill-available;
      width: 100svw;
      height: 100vh;
      height: -webkit-fill-available;
      height: 100svh;
      touch-action: none;
    }

    /* Floating Panel */
    .controls {
      position: absolute;
      top: 68px;
      left: 20px;
      left: max(20px, env(safe-area-inset-left));
      background: var(--backdrop-blur);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      z-index: 1000;
      min-width: 200px;
      max-width: calc(100vw - 40px);
      max-width: calc(100svw - 40px - env(safe-area-inset-left) - env(safe-area-inset-right));
      max-height: 80vh;
      max-height: -webkit-fill-available;
      max-height: 80svh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .controls.expanded {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .controls > * {
      max-width: 100%;
      box-sizing: border-box;
    }

    /* Title */
    .panel-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--fg-primary);
      margin-bottom: 12px;
      display: block;
    }

    /* Control groups */
    .control-group {
      margin-bottom: 12px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-label {
      font-size: 12px;
      color: var(--fg-secondary);
      margin-bottom: 4px;
      display: block;
    }

    /* Action buttons */
    .action-btn {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 8px;
      background: color-mix(in srgb, var(--bg-secondary) 80%, var(--border) 20%);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--fg-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }

    .action-btn:hover {
      background: color-mix(in srgb, var(--bg-secondary) 60%, var(--border) 40%);
      border-color: color-mix(in srgb, var(--border) 70%, var(--fg-secondary) 30%);
    }

    .action-btn:active {
      opacity: 0.8;
    }

    .action-btn:last-child {
      margin-bottom: 0;
    }

    /* Input styling */
    input[type=file] {
      display: none;
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
      width: 100%;
    }

    input[type=number] {
      flex: 1;
      min-width: 0;
      background: var(--bg-secondary);
      color: var(--fg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      -moz-appearance: textfield;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number]:focus {
      border-color: var(--fg-secondary);
    }

    .compute-btn {
      margin-bottom: 0;
      flex-shrink: 0;
      padding: 8px 16px;
      width: auto;
    }

    /* Stats display */
    .stats {
      font-size: 12px;
      color: var(--fg-secondary);
      line-height: 1.5;
    }

    .stats div {
      margin-bottom: 2px;
    }

    .stats div:last-child {
      margin-bottom: 0;
    }

    /* Dropzone styling */
    .dropzone {
      padding: 12px;
      border: 2px dashed var(--border);
      border-radius: 6px;
      text-align: center;
      color: var(--fg-secondary);
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .dropzone.dragover {
      background: rgba(255,255,255,0.05);
      border-color: var(--fg-secondary);
    }

    /* Debug console */
    .debug-container {
      position: absolute;
      bottom: 10px;
      bottom: max(10px, env(safe-area-inset-bottom));
      right: 10px;
      right: max(10px, env(safe-area-inset-right));
      width: 360px;
      max-width: calc(100vw - 20px);
      max-width: calc(100svw - 20px - env(safe-area-inset-left) - env(safe-area-inset-right));
      z-index: 10000;
    }

    .debug-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .copy-log-btn {
      background: var(--backdrop-blur);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
      color: var(--fg-primary);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
      white-space: nowrap;
    }

    .copy-log-btn:hover {
      background: color-mix(in srgb, var(--bg-secondary) 60%, var(--border) 40%);
      border-color: color-mix(in srgb, var(--border) 70%, var(--fg-secondary) 30%);
    }

    .copy-log-btn:active {
      opacity: 0.8;
    }

    .copy-log-btn.copied {
      background: color-mix(in srgb, #4caf50 20%, var(--bg-secondary) 80%);
      border-color: #4caf50;
    }

    #debugConsole {
      width: 100%;
      height: 180px;
      max-height: 30vh;
      max-height: 30svh;
      background: var(--backdrop-blur);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 8px;
      color: var(--fg-secondary);
      font-family: ui-monospace, 'SF Mono', Monaco, 'Cascadia Mono', 'Courier New', monospace;
      font-size: 11px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    #debugConsole::-webkit-scrollbar {
      width: 8px;
    }

    #debugConsole::-webkit-scrollbar-track {
      background: transparent;
    }

    #debugConsole::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    #debugConsole::-webkit-scrollbar-thumb:hover {
      background: var(--fg-secondary);
    }

    #debugConsole b.error { color: #ff6b6b; }
    #debugConsole b.warn { color: #ffd93d; }
    #debugConsole b.log { color: var(--fg-primary); }

    /* Custom scrollbar for controls panel */
    .controls::-webkit-scrollbar {
      width: 8px;
    }

    .controls::-webkit-scrollbar-track {
      background: transparent;
    }

    .controls::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .controls::-webkit-scrollbar-thumb:hover {
      background: var(--fg-secondary);
    }

    /* Top buttons */
    .top-left-buttons {
      position: absolute;
      top: 20px;
      top: max(20px, env(safe-area-inset-top));
      left: 20px;
      left: max(20px, env(safe-area-inset-left));
      display: flex;
      gap: 8px;
      z-index: 1001;
    }

    .top-right-buttons {
      position: absolute;
      top: 20px;
      top: max(20px, env(safe-area-inset-top));
      right: 20px;
      right: max(20px, env(safe-area-inset-right));
      display: flex;
      gap: 8px;
      z-index: 1001;
    }

    .options-button {
      background: var(--backdrop-blur);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--fg-primary);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    .options-button:hover {
      background: color-mix(in srgb, var(--bg-secondary) 60%, var(--border) 40%);
      border-color: color-mix(in srgb, var(--border) 70%, var(--fg-secondary) 30%);
    }

    .options-button:active {
      opacity: 0.8;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .top-left-buttons {
        top: 15px;
        left: 15px;
      }

      .top-right-buttons {
        top: 15px;
        right: 15px;
      }

      .controls {
        top: 60px;
        left: 15px;
        padding: 12px;
        min-width: 180px;
        max-height: 60vh;
        max-height: -webkit-fill-available;
        max-height: 60svh;
      }

      .debug-container {
        display: none;
      }

      .compute-btn {
        padding: 8px 12px;
        font-size: 12px;
      }

      .options-button {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <!-- Top Left Buttons -->
  <div class="top-left-buttons">
    <button class="options-button" id="optionsBtn">Options</button>
  </div>

  <!-- Top Right Buttons -->
  <div class="top-right-buttons">
    <button class="options-button" id="restart">Restart Animation</button>
  </div>

  <div class="controls" id="controlsPanel">
    <span class="panel-title">BCC Permutahedron Voxelization</span>

    <div class="control-group">
      <label class="control-label">Model</label>
      <input type="file" id="fileInput" accept=".obj" style="display: none;">
      <button class="action-btn" id="uploadBtn">Upload OBJ File</button>
      <div id="dropzone" class="dropzone">or drag & drop .OBJ here</div>
    </div>

    <div class="control-group">
      <label class="control-label">Scale</label>
      <div class="input-row">
        <input type="number" id="scaleInput" min="0.1" max="100" step="0.1" value="1">
        <button class="action-btn compute-btn" id="computeBtn">Compute</button>
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">Statistics</label>
      <div class="stats">
        <div>Total Voxels: <span id="totalCubes">0</span></div>
        <div>Memory: <span id="memoryUsage">--</span></div>
        <div>Voxelization: <span id="voxelTime">--</span></div>
      </div>
    </div>
  </div>
  <div class="debug-container">
    <div class="debug-header">
      <button class="copy-log-btn" id="copyLogBtn">Copy Log</button>
    </div>
    <div id="debugConsole"></div>
  </div>

  <script type="module">
    import { loadOBJFile, loadOBJFromURL } from './loader.js';
    import { Renderer, voxelizeModel, centerModel, applyScale } from './renderer.js';

    // --- On-screen debug console ---
    (function(){
      const box = document.getElementById('debugConsole');
      const add = (msg, cls = 'log') => {
        const e = document.createElement('div');
        e.innerHTML = `<b class="${cls}">[${cls.toUpperCase()}]</b> ${msg}`;
        box.appendChild(e);
        box.scrollTop = box.scrollHeight;
      };
      const wrap = (fn, cls) => function(...a) {
        add(a.map(x => typeof x === 'object' ? JSON.stringify(x) : x).join(' '), cls);
        fn.apply(console, a);
      };
      console.log = wrap(console.log, 'log');
      console.warn = wrap(console.warn, 'warn');
      console.error = wrap(console.error, 'error');
      window.addEventListener('error', e => add(e.message, 'error'));
      window.addEventListener('unhandledrejection', e => add('Promise: ' + e.reason, 'error'));
    })();

    // === Initialize renderer ===
    const canvas = document.getElementById('canvas');
    let renderer;

    try {
      renderer = new Renderer(canvas);
    } catch (error) {
      alert('WebGL2 not supported');
      throw error;
    }

    // === Model management ===
    let currentModel = null;
    let modelScale = 1.0;

    function processModel() {
      if (!currentModel) return;

      const centered = centerModel(currentModel);
      const scaled = applyScale(centered, modelScale);
      const result = voxelizeModel(scaled);

      const stats = renderer.updateInstances(result.voxels);

      // Update UI
      document.getElementById('totalCubes').textContent = stats.count;
      document.getElementById('memoryUsage').textContent = `${stats.totalKB} KB`;
      document.getElementById('voxelTime').textContent = `${result.time} ms`;
    }

    // === File upload ===
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const drop = document.getElementById('dropzone');
    const scaleInput = document.getElementById('scaleInput');
    const computeBtn = document.getElementById('computeBtn');

    uploadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async (e) => {
      if (e.target.files[0]) {
        try {
          currentModel = await loadOBJFile(e.target.files[0]);
          processModel();
        } catch (error) {
          console.error('Failed to load OBJ file:', error);
        }
      }
    });

    drop.addEventListener('dragover', (e) => {
      e.preventDefault();
      drop.classList.add('dragover');
    });

    drop.addEventListener('dragleave', () => {
      drop.classList.remove('dragover');
    });

    drop.addEventListener('drop', async (e) => {
      e.preventDefault();
      drop.classList.remove('dragover');
      if (e.dataTransfer.files[0]) {
        try {
          currentModel = await loadOBJFile(e.dataTransfer.files[0]);
          processModel();
        } catch (error) {
          console.error('Failed to load OBJ file:', error);
        }
      }
    });

    function applyScaleChange() {
      const val = parseFloat(scaleInput.value);
      if (val > 0) {
        modelScale = val;
        processModel();
      }
    }

    computeBtn.addEventListener('click', applyScaleChange);

    scaleInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        applyScaleChange();
      }
    });

    // === Options panel toggle ===
    const optionsBtn = document.getElementById('optionsBtn');
    const controlsPanel = document.getElementById('controlsPanel');
    let panelVisible = false;

    optionsBtn.addEventListener('click', () => {
      panelVisible = !panelVisible;
      if (panelVisible) {
        controlsPanel.classList.add('expanded');
        optionsBtn.textContent = 'Close';
      } else {
        controlsPanel.classList.remove('expanded');
        optionsBtn.textContent = 'Options';
      }
    });

    // === Restart animation ===
    document.getElementById('restart').onclick = () => renderer.restartAnimation();

    // === Copy log button ===
    const copyLogBtn = document.getElementById('copyLogBtn');
    copyLogBtn.addEventListener('click', async () => {
      const debugConsole = document.getElementById('debugConsole');
      const logText = debugConsole.innerText;

      try {
        await navigator.clipboard.writeText(logText);
        copyLogBtn.textContent = 'Copied!';
        copyLogBtn.classList.add('copied');

        setTimeout(() => {
          copyLogBtn.textContent = 'Copy Log';
          copyLogBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy log:', err);
        copyLogBtn.textContent = 'Failed';
        setTimeout(() => {
          copyLogBtn.textContent = 'Copy Log';
        }, 2000);
      }
    });

    // === Load default model on startup ===
    console.log("Loading default permutahedron model...");
    loadOBJFromURL('./examples/permutahedron.obj')
      .then(model => {
        currentModel = model;
        processModel();
        console.log("Default model loaded. Ready for OBJ upload.");
      })
      .catch(error => {
        console.error('Failed to load default model:', error);
      });
  </script>
</body>
</html>
