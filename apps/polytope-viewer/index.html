<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polytope Viewer</title>

    <!-- DNS Prefetch - resolve domain names early -->
    <link rel="dns-prefetch" href="https://esm.sh">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- Preconnect - establish full connection (DNS + TLS) -->
    <link rel="preconnect" href="https://esm.sh" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    <!-- Module Preload - download critical modules early -->
    <link rel="modulepreload" href="polytope-viewer.js">
    <link rel="modulepreload" href="polytope-data.js">
    <link rel="modulepreload" href="https://esm.sh/three@0.160.0" crossorigin>
    <link rel="modulepreload" href="https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js" crossorigin>

    <link rel="stylesheet" href="polytopestyles.css">
    <script src="polytope-viewer.js"></script>
    <script type="module" src="polytope-data.js"></script>

    <!-- Add to polytopestyles.css in a <style> block or external file -->
    <style>
        /* Loading skeleton */
        .skeleton-loader {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            z-index: 999;
            transition: opacity 0.3s ease;
        }

        .skeleton-loader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .skeleton-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--fg-secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @media (prefers-reduced-motion: reduce) {
            .skeleton-spinner {
                animation: none;
                border-top-color: var(--border);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton-text {
            font-size: 14px;
            color: var(--fg-secondary);
        }
    </style>
</head>
<body>
    <!-- Options Button -->
    <button class="options-button" id="optionsBtn">options</button>

    <!-- Top Right Select Button -->
    <button class="select-polytope-btn" id="selectPolytopeBtn">
        select polytope
    </button>

    <!-- Fullscreen polytope viewer -->
    <polytope-viewer id="viewer" style="position: relative;" vertices='[
  [-2.121320343559642, -0.408248290463863,  0.577350269189626],
  [-2.121320343559642,  0.408248290463863, -0.577350269189626],
  [-1.414213562373095, -1.632993161855452,  0.577350269189626],
  [-1.414213562373095,  0.000000000000000, -1.732050807568877],
  [-1.414213562373095,  0.000000000000000,  1.732050807568877],
  [-1.414213562373095,  1.632993161855452, -0.577350269189626],
  [-0.707106781186548, -2.041241452319315, -0.577350269189626],
  [-0.707106781186548, -1.224744871391589, -1.732050807568877],
  [-0.707106781186548, -1.224744871391589,  1.732050807568877],
  [-0.707106781186548,  1.224744871391589, -1.732050807568877],
  [-0.707106781186548,  1.224744871391589,  1.732050807568877],
  [-0.707106781186548,  2.041241452319315,  0.577350269189626],
  [ 0.707106781186548, -2.041241452319315, -0.577350269189626],
  [ 0.707106781186548, -1.224744871391589, -1.732050807568877],
  [ 0.707106781186548, -1.224744871391589,  1.732050807568877],
  [ 0.707106781186548,  1.224744871391589, -1.732050807568877],
  [ 0.707106781186548,  1.224744871391589,  1.732050807568877],
  [ 0.707106781186548,  2.041241452319315,  0.577350269189626],
  [ 1.414213562373095, -1.632993161855452,  0.577350269189626],
  [ 1.414213562373095,  0.000000000000000, -1.732050807568877],
  [ 1.414213562373095,  0.000000000000000,  1.732050807568877],
  [ 1.414213562373095,  1.632993161855452, -0.577350269189626],
  [ 2.121320343559642, -0.408248290463863,  0.577350269189626],
  [ 2.121320343559642,  0.408248290463863, -0.577350269189626]
]'>
        <!-- Loading skeleton - removed when component loads -->
        <div class="skeleton-loader" aria-live="polite" aria-label="Loading polytope visualization">
            <div class="skeleton-spinner"></div>
            <div class="skeleton-text">constructing polytope...</div>
        </div>
    </polytope-viewer>
    
    <!-- Left Controls Panel (Starts hidden) -->
    <div class="floating-panel controls-panel" id="controlsPanel" style="display: none;">
        <div class="control-group">
            <label class="control-label">Display Mode</label>
            <div class="toggle-wrapper">
                <div class="toggle" id="wireframeToggle"></div>
                <span class="toggle-label">Wireframe</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Opacity</label>
            <div class="slider-wrapper">
                <input type="range" class="slider" id="opacitySlider"
                       min="0" max="1" step="0.1" value="0.9">
                <div class="slider-value" id="opacityValue">90%</div>
            </div>
        </div>
    </div>

    <!-- Polytope Selector Modal with Scrolling -->
    <div class="modal-overlay" id="polytopeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Polytope</h2>
                <button class="close-button" id="closeModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="polytope-grid" id="polytopeGrid">
                    <!-- Polytope cards will be dynamically generated from polytope-data.js -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { polytopeOptions, getPolytopeVertices } from './polytope-data.js';

        const viewer = document.getElementById('viewer');

        // Remove loading skeleton when component is ready
        customElements.whenDefined('polytope-viewer').then(() => {
            const skeleton = viewer.querySelector('.skeleton-loader');
            if (skeleton) {
                skeleton.classList.add('fade-out');
                setTimeout(() => skeleton.remove(), 300);
            }
        });

        const wireframeToggle = document.getElementById('wireframeToggle');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const selectPolytopeBtn = document.getElementById('selectPolytopeBtn');
        const polytopeModal = document.getElementById('polytopeModal');
        const closeModal = document.getElementById('closeModal');
        const polytopeGrid = document.getElementById('polytopeGrid');
        const optionsBtn = document.getElementById('optionsBtn');
        const controlsPanel = document.getElementById('controlsPanel');

        // Generate polytope cards from data
        function generatePolytopeCards() {
            polytopeGrid.innerHTML = '';
            polytopeOptions.forEach(polytope => {
                const card = document.createElement('div');
                card.className = 'polytope-card';
                if (polytope.active) {
                    card.classList.add('active');
                }
                card.dataset.polytope = polytope.id;

                card.innerHTML = `
                    <div class="polytope-name">${polytope.name}</div>
                    <div class="polytope-description">${polytope.description}</div>
                `;

                polytopeGrid.appendChild(card);
            });
        }

        // Modal functionality with body scroll prevention
        function openModal() {
            polytopeModal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModalFunc() {
            polytopeModal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        selectPolytopeBtn.addEventListener('click', openModal);
        closeModal.addEventListener('click', closeModalFunc);

        // Close modal when clicking outside
        polytopeModal.addEventListener('click', (e) => {
            if (e.target === polytopeModal) {
                closeModalFunc();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && polytopeModal.classList.contains('active')) {
                closeModalFunc();
            }
        });

        // Options panel toggle functionality
        let panelVisible = false;

        optionsBtn.addEventListener('click', () => {
            panelVisible = !panelVisible;
            if (panelVisible) {
                controlsPanel.style.display = 'block';
                // Force reflow before adding class for smooth animation
                controlsPanel.offsetHeight;
                controlsPanel.classList.add('expanded');
                optionsBtn.textContent = 'close';
            } else {
                controlsPanel.classList.remove('expanded');
                // Wait for animation to complete before hiding
                setTimeout(() => {
                    if (!panelVisible) { // Check again in case user clicked during animation
                        controlsPanel.style.display = 'none';
                    }
                }, 300); // Match CSS transition duration
                optionsBtn.textContent = 'options';
            }
        });

        // Wireframe toggle functionality
        wireframeToggle.addEventListener('click', () => {
            wireframeToggle.classList.toggle('active');
            const isWireframe = wireframeToggle.classList.contains('active');
            viewer.setAttribute('wireframe', isWireframe ? 'true' : 'false');
        });

        // Opacity slider functionality
        opacitySlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            const percentage = Math.round(value * 100);
            opacityValue.textContent = `${percentage}%`;
            viewer.setAttribute('opacity', value.toString());
        });

        // Polytope selection functionality
        function setupPolytopeSelection() {
            polytopeGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.polytope-card');
                if (!card) return;

                // Update active state
                const polytopeCards = polytopeGrid.querySelectorAll('.polytope-card');
                polytopeCards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');

                // Get polytope type and set vertices
                const polytopeType = card.dataset.polytope;
                const vertices = getPolytopeVertices(polytopeType);
                viewer.setAttribute('vertices', JSON.stringify(vertices));

                // Close modal
                closeModalFunc();
            });
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            opacityValue.textContent = '90%';
            generatePolytopeCards();
            setupPolytopeSelection();
        });
    </script>
</body>
</html>