<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Voronoi Lab â€” Plain HTML/JS</title>
  <style>
    /* CSS Variables for theming - dark mode matching xochi voronoi-viewer */
    :root {
      --bg-primary: #161617;
      --bg-secondary: #1c1c1e;
      --fg-primary: #f3f3f3;
      --fg-secondary: #b9b9b9;
      --border: #222224;
      --shadow: 0 8px 24px rgba(0,0,0,0.5);
      --backdrop-blur: rgba(28, 28, 30, 0.9);
      --radius: 12px;
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      height:100vh;
      height:-webkit-fill-available;
      height:100svh;
      overflow:hidden;
      touch-action:none;
      -ms-touch-action:none;
      -webkit-overflow-scrolling:touch;
    }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color:var(--fg-primary);
      background: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      visibility:visible;
    }

    /* Canvas area */
    .canvas-shell{
      position:relative;
      padding:16px;
      padding-top:max(16px, env(safe-area-inset-top));
      padding-right:max(16px, env(safe-area-inset-right));
      padding-bottom:max(16px, env(safe-area-inset-bottom));
      padding-left:max(16px, env(safe-area-inset-left));
    }
    .canvas-wrap{
      height:72vh;
      height:72svh;
      min-height:420px;
      width:100%;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:color-mix(in srgb, var(--bg-secondary) 80%, var(--border) 20%);
    }
    .change-btn{
      position:absolute;
      top:20px;
      right:20px;
      border:1.5px solid color-mix(in srgb, var(--border) 80%, var(--fg-secondary) 20%);
      background:color-mix(in srgb, var(--bg-secondary) 95%, var(--fg-primary) 5%);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      color:var(--fg-primary);
      padding:8px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s ease;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .change-btn:hover{
      background:color-mix(in srgb, var(--bg-secondary) 85%, var(--fg-primary) 15%);
      border-color:color-mix(in srgb, var(--border) 60%, var(--fg-secondary) 40%);
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .hint{position:absolute; left:0; right:0; bottom:14px; text-align:center; font-size:12px; color:var(--fg-secondary)}

    /* Modal */
    .modal-root{position:fixed; inset:0; display:grid; place-items:center; z-index:50}
    .backdrop{
      position:absolute;
      inset:0;
      background:color-mix(in srgb, var(--bg-primary) 60%, transparent 40%);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
    }
    .modal{
      position:relative;
      z-index:1;
      width:min(1400px,98vw);
      height:94vh;
      height:-webkit-fill-available;
      height:94svh;
      border-radius:18px;
      border:1px solid var(--border);
      background:var(--bg-secondary);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .modal .top{padding:18px 20px 14px; border-bottom:1px solid var(--border)}
    .modal .top .label{margin-bottom:8px; font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:var(--fg-secondary)}
    .grid{display:grid; gap:8px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:560px){.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:768px){.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}
    @media(min-width:1024px){.grid.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}}
    @media(min-width:1280px){.grid.cols-6{grid-template-columns:repeat(6,minmax(0,1fr))}}

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      border:1.5px solid color-mix(in srgb, var(--border) 80%, var(--fg-secondary) 20%);
      background:color-mix(in srgb, var(--bg-secondary) 95%, var(--fg-primary) 5%);
      color:var(--fg-primary);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    .chip:hover{
      background:color-mix(in srgb, var(--bg-secondary) 85%, var(--fg-primary) 15%);
      border-color:color-mix(in srgb, var(--border) 60%, var(--fg-secondary) 40%);
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      transform:translateY(-1px);
    }
    .chip.active{
      background:color-mix(in srgb, var(--fg-secondary) 40%, var(--bg-secondary) 60%);
      border-color:var(--fg-secondary);
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .chip svg{width:22px; height:22px; color:var(--fg-primary)}
    .chip span{font-size:14px; font-weight:600; white-space:nowrap}

    .body{
      padding:18px 20px;
      height:calc(94vh - 64px - 64px);
      height:calc(94svh - 64px - 64px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .cols{display:grid; gap:16px}
    @media(min-width:900px){.cols{grid-template-columns:3fr 4fr}}
    .example{border:1px solid var(--border); border-radius:14px; background:color-mix(in srgb, var(--bg-secondary) 80%, var(--border) 20%); aspect-ratio:4/3; overflow:hidden}
    .example-note{margin-top:6px; font-size:12px; color:var(--fg-secondary)}

    .title-row{display:flex; align-items:center; gap:10px}
    .unit-tag{font-size:10px; padding:2px 6px; border:1px solid var(--border); border-radius:999px; color:var(--fg-secondary)}
    .desc{color:var(--fg-secondary); font-size:14px; line-height:1.5}
    .notes{color:var(--fg-secondary); font-size:12px}
    .notes ul{margin:6px 0 0 18px}

    .footer{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top:1px solid var(--border);
      padding:12px 20px;
      background:var(--backdrop-blur);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
    }
    .toggle{
      display:inline-flex;
      gap:4px;
      padding:4px;
      border-radius:999px;
      background:color-mix(in srgb, var(--bg-secondary) 95%, var(--fg-primary) 5%);
      border:1.5px solid color-mix(in srgb, var(--border) 80%, var(--fg-secondary) 20%);
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    .toggle button{
      border:0;
      background:transparent;
      color:var(--fg-secondary);
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:all 0.2s ease;
      font-weight:500;
    }
    .toggle button.active{
      background:color-mix(in srgb, var(--fg-secondary) 40%, var(--bg-secondary) 60%);
      color:var(--fg-primary);
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      font-weight:600;
    }

    .btn{
      border:1.5px solid color-mix(in srgb, var(--border) 80%, var(--fg-secondary) 20%);
      background:color-mix(in srgb, var(--bg-secondary) 95%, var(--fg-primary) 5%);
      color:var(--fg-primary);
      padding:8px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s ease;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }
    .btn:hover{
      background:color-mix(in srgb, var(--bg-secondary) 85%, var(--fg-primary) 15%);
      border-color:color-mix(in srgb, var(--border) 60%, var(--fg-secondary) 40%);
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    .btn.primary{
      background:color-mix(in srgb, var(--fg-secondary) 75%, var(--bg-secondary) 25%);
      color:var(--fg-primary);
      border-color:var(--fg-secondary);
      font-weight:700;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .btn.primary:hover{
      background:color-mix(in srgb, var(--fg-secondary) 85%, var(--bg-secondary) 15%);
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
      transform:translateY(-1px);
    }

    /* Small glyphs */
    .g{width:24px;height:24px;color:var(--fg-primary)}

    /* iOS-specific adjustments */
    @supports (-webkit-touch-callout: none) {
      body{
        height:100vh;
        height:-webkit-fill-available;
        height:100svh;
      }
      .modal{
        max-height:94svh;
      }
      .body{
        max-height:calc(94svh - 128px);
      }
    }

    /* Responsive adjustments for mobile */
    @media (max-width: 768px) {
      .canvas-shell{
        padding:12px;
        padding-top:max(12px, env(safe-area-inset-top));
        padding-right:max(12px, env(safe-area-inset-right));
        padding-bottom:max(12px, env(safe-area-inset-bottom));
        padding-left:max(12px, env(safe-area-inset-left));
      }
      .change-btn{
        top:max(15px, env(safe-area-inset-top, 15px));
        right:max(15px, env(safe-area-inset-right, 15px));
      }
    }
  </style>
</head>
<body>
  <main class="canvas-shell">
    <button id="changeMetric" class="change-btn" aria-haspopup="dialog">Change metric</button>
    <div class="canvas-wrap">
      <canvas id="canvas" style="width:100%; height:100%; display:block"></canvas>
    </div>
    <div class="hint">Add seeds, drag points, and more interactions will go here.</div>
  </main>

  <!-- Modal -->
  <div id="pickerRoot" class="modal-root" role="dialog" aria-modal="true" aria-labelledby="pickerTitle" hidden>
    <div class="backdrop" id="backdrop"></div>
    <section class="modal" aria-describedby="pickerDesc">
      <div class="top">
        <div id="pickerTitle" class="label">Choose a metric</div>
        <div id="chipGrid" class="grid cols-2 cols-3 cols-4 cols-5 cols-6" role="listbox" aria-label="Metric choices"></div>
      </div>

      <div class="body">
        <div class="cols">
          <div>
            <div class="example">
              <!-- Example Voronoi diagram (placeholder) -->
              <svg viewBox="0 0 400 300" width="100%" height="100%">
                <rect x="0" y="0" width="400" height="300" fill="#161617" />
                <polygon points="10,40 120,20 120,120 40,160" fill="#1c1c1e" stroke="#222224"/>
                <polygon points="120,20 230,40 220,140 120,120" fill="#242426" stroke="#222224"/>
                <polygon points="40,160 120,120 200,200 80,260" fill="#1c1c1e" stroke="#222224"/>
                <polygon points="230,40 390,30 380,150 220,140" fill="#1c1c1e" stroke="#222224"/>
                <polygon points="200,200 320,170 380,280 140,280" fill="#242426" stroke="#222224"/>
                <circle cx="60" cy="80" r="3" fill="#b9b9b9"/>
                <circle cx="170" cy="70" r="3" fill="#b9b9b9"/>
                <circle cx="260" cy="110" r="3" fill="#b9b9b9"/>
                <circle cx="130" cy="200" r="3" fill="#b9b9b9"/>
                <circle cx="330" cy="220" r="3" fill="#b9b9b9"/>
                <text x="14" y="24" font-family="ui-sans-serif" font-size="12" fill="#b9b9b9">Example diagram</text>
              </svg>
            </div>
            <div class="example-note">Representative example (not computed).</div>
          </div>

          <div>
            <div class="title-row">
              <span id="detailGlyph"></span>
              <h2 id="detailTitle" style="margin:0; font-size:20px; font-weight:700"></h2>
              <span class="unit-tag">unit ball</span>
            </div>
            <p id="detailNotes" class="desc" style="margin-top:8px"></p>
            <div class="notes">
              <p class="font-medium" style="margin:10px 0 4px 0; color:var(--fg-secondary)">Notes</p>
              <ul>
                <li>Stability: placeholder blurb about numerical stability.</li>
                <li>Complexity: placeholder blurb about algorithmic cost.</li>
                <li>Use cases: placeholder blurb with typical scenarios.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="toggle" role="group" aria-label="Approx vs Exact">
          <button id="tExact" class="active" aria-pressed="true">Exact</button>
          <button id="tApprox" aria-pressed="false">Approximate</button>
        </div>
        <div>
          <button id="cancelBtn" class="btn" style="margin-right:6px">Cancel</button>
          <button id="selectBtn" class="btn primary">Select</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----------------------------- Data -------------------------------------
    const METRICS = [
      { id: "euclidean", name: "Euclidean (L2)", glyph: "circle", notes: "Rotationally symmetric; straight-line distance. Unit ball is a circle." },
      { id: "manhattan", name: "Manhattan (L1)", glyph: "diamond", notes: "Sum of absolute differences. Unit ball is a 45Â° diamond." },
      { id: "chebyshev", name: "Chebyshev (Lâˆž)", glyph: "square", notes: "Max metric; distance equals the largest coordinate difference. Unit ball is a square." },
      { id: "minkowski15", name: "Minkowski (p=1.5)", glyph: "roundedDiamond", notes: "Interpolates between L1 and L2. Unit ball squarish with rounded corners." },
      { id: "weighted", name: "Weighted L2", glyph: "ellipse", notes: "Axis-aligned anisotropy; scales per-axis. Unit ball is an ellipse." },
      { id: "anisotropic", name: "Anisotropic", glyph: "rotatedEllipse", notes: "Full anisotropy with rotation. Unit ball is a rotated ellipse." },
      { id: "mahalanobis", name: "Mahalanobis", glyph: "tiltedEllipse", notes: "Covariance-aware distance; whitening transform. Unit ball is a tilted ellipse." },
      { id: "hex", name: "Hex Norm", glyph: "hexagon", notes: "Approximates circular distance with 6 directions; hexagonal unit ball." },
      { id: "taxicab-skew", name: "Skewed L1", glyph: "skewDiamond", notes: "L1 under shear/affine skew. Unit ball is a skewed diamond." },
      { id: "custom", name: "Custom Kernel", glyph: "star", notes: "Plug your own kernel here. Shape below is just a placeholder." },
    ];

    // --------------------------- State --------------------------------------
    let mode = 'exact'; // 'exact' | 'approx'
    let selectedMetric = METRICS[0];

    // ------------------------- DOM Helpers ----------------------------------
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // -------------------------- Glyphs --------------------------------------
    function glyphSVG(kind){
      const common = 'fill="none" stroke="currentColor" stroke-width="2"';
      switch(kind){
        case 'circle': return `<svg viewBox="0 0 64 64" class="g"><circle cx="32" cy="32" r="18" ${common}/></svg>`;
        case 'diamond': return `<svg viewBox="0 0 64 64" class="g"><polygon points="32,12 52,32 32,52 12,32" ${common}/></svg>`;
        case 'square': return `<svg viewBox="0 0 64 64" class="g"><rect x="14" y="14" width="36" height="36" ${common}/></svg>`;
        case 'roundedDiamond': return `<svg viewBox="0 0 64 64" class="g"><path d="M32 10 C40 14, 50 24, 54 32 C50 40, 40 50, 32 54 C24 50, 14 40, 10 32 C14 24, 24 14, 32 10 Z" ${common}/></svg>`;
        case 'ellipse': return `<svg viewBox="0 0 64 64" class="g"><ellipse cx="32" cy="32" rx="22" ry="14" ${common}/></svg>`;
        case 'rotatedEllipse': return `<svg viewBox="0 0 64 64" class="g"><g transform="rotate(-30 32 32)"><ellipse cx="32" cy="32" rx="22" ry="12" ${common}/></g></svg>`;
        case 'tiltedEllipse': return `<svg viewBox="0 0 64 64" class="g"><g transform="rotate(20 32 32)"><ellipse cx="32" cy="32" rx="20" ry="14" ${common}/></g></svg>`;
        case 'hexagon': return `<svg viewBox="0 0 64 64" class="g"><polygon points="32,10 48,20 48,44 32,54 16,44 16,20" ${common}/></svg>`;
        case 'skewDiamond': return `<svg viewBox="0 0 64 64" class="g"><g transform="skewX(20)"><polygon points="32,12 52,32 32,52 12,32" ${common}/></g></svg>`;
        case 'star': return `<svg viewBox="0 0 64 64" class="g"><path d="M32 10 L37 26 L54 26 L40 36 L46 52 L32 42 L18 52 L24 36 L10 26 L27 26 Z" ${common}/></svg>`;
        default: return '';
      }
    }

    // --------------------------- Modal Grid ---------------------------------
    function renderChips(){
      const grid = $('#chipGrid');
      grid.innerHTML = '';
      METRICS.forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'chip' + (m.id === selectedMetric.id ? ' active' : '');
        btn.setAttribute('role','option');
        btn.setAttribute('aria-selected', m.id === selectedMetric.id);
        btn.innerHTML = `${glyphSVG(m.glyph)}<span>${m.name}</span>`;
        btn.addEventListener('click', ()=> { selectedMetric = m; updateDetail(); renderChips(); });
        grid.appendChild(btn);
      });
    }

    function updateDetail(){
      $('#detailGlyph').innerHTML = glyphSVG(selectedMetric.glyph);
      $('#detailTitle').textContent = selectedMetric.name;
      $('#detailNotes').textContent = selectedMetric.notes;
    }

    // --------------------------- Canvas -------------------------------------
    function drawCanvas(){
      const canvas = $('#canvas');
      if(!canvas) return;
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);

      // clear
      ctx.clearRect(0,0,rect.width,rect.height);

      // grid
      ctx.save();
      ctx.strokeStyle = '#222224';
      ctx.lineWidth = 1;
      for(let x=0; x<rect.width; x+=24){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,rect.height); ctx.stroke(); }
      for(let y=0; y<rect.height; y+=24){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(rect.width,y+0.5); ctx.stroke(); }
      ctx.restore();

      // text
      ctx.save();
      ctx.font = '600 16px ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif';
      ctx.fillStyle = '#b9b9b9';
      ctx.fillText('Voronoi preview coming soonâ€¦', 20, 40);
      ctx.fillText(`Metric: ${selectedMetric.name}`, 20, 66);
      ctx.fillText(`Mode: ${mode === 'exact' ? 'Exact' : 'Approximate'}`, 20, 92);
      ctx.restore();
    }

    // --------------------------- Toggle -------------------------------------
    function setToggle(value){
      mode = value;
      $('#tExact').classList.toggle('active', value === 'exact');
      $('#tExact').setAttribute('aria-pressed', value === 'exact');
      $('#tApprox').classList.toggle('active', value === 'approx');
      $('#tApprox').setAttribute('aria-pressed', value === 'approx');
    }

    // --------------------------- Modal Show/Hide -----------------------------
    function openPicker(){ $('#pickerRoot').hidden = false; }
    function closePicker(){ $('#pickerRoot').hidden = true; }

    // --------------------------- Events -------------------------------------
    window.addEventListener('resize', drawCanvas);

    $('#changeMetric').addEventListener('click', openPicker);
    $('#backdrop').addEventListener('click', closePicker);
    $('#cancelBtn').addEventListener('click', closePicker);
    $('#selectBtn').addEventListener('click', ()=>{ closePicker(); drawCanvas(); });

    $('#tExact').addEventListener('click', ()=> setToggle('exact'));
    $('#tApprox').addEventListener('click', ()=> setToggle('approx'));

    // --------------------------- Init ---------------------------------------
    renderChips();
    updateDetail();
    setToggle('exact');
    drawCanvas();
    // Start with the picker open for first-run selection
    openPicker();
  </script>
</body>
</html>
