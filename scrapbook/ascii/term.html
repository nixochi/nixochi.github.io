<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: black;
        height: 100vh;
        height: -webkit-fill-available;
        height: 100svh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #terminal {
        display: inline-block;
        position: relative;
        z-index: 1;
      }

      #glCanvas {
        display: none;
      }
    </style>
  </head>
  <body>
    <canvas id="glCanvas"></canvas>
    <div id="terminal"></div>


    <script type="module" src="./commands.js"></script>
    <script type="module" src="./interactionStateMachine.js"></script>

    <script type="module">
      import { commandHandler } from './commands.js';
      import { interactionStateMachine } from './interactionStateMachine.js';


      var term = new Terminal({
        cursorBlink: true,
        fontSize: 16,
        cols: 120,
        rows: 50
      });
      term.open(document.getElementById('terminal'));

      // Add state properties directly to term
      term.currentLine = '';
      term.cursorPos = 0;
      term.commandHistory = [];
      term.historyIndex = -1;
      term.tempLine = '';
      term.drawingState = "terminal";

      term.write('$ ')

      const commandExecutor = new commandHandler(term);
      const interactionHandler = new interactionStateMachine(term, commandExecutor);

      // Make commandExecutor globally available for sliders
      window.commandExecutor = commandExecutor;

      // Handle keyboard input
      term.onData(data => interactionHandler.handleInteraction(data));
    </script>

    <!-- Permutahedron Controls -->
    <div id="permutahedron-controls" style="position: fixed; top: 10px; right: 10px; width: 300px; background: rgba(0, 0, 0, 0.8); color: white; padding: 15px; font-family: monospace; font-size: 12px; border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.3); z-index: 9999; display: none;">
      <div style="font-weight: bold; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.3); padding-bottom: 5px;">Permutahedron Controls</div>

      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 3px;">Camera Distance: <span id="camera-radius-value">1.8</span></label>
        <input type="range" id="camera-radius" min="0.5" max="5" step="0.1" value="1.8" style="width: 100%;">
      </div>

      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 3px;">Field of View: <span id="camera-fov-value">70</span></label>
        <input type="range" id="camera-fov" min="30" max="120" step="5" value="70" style="width: 100%;">
      </div>

      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 3px;">Rotation Speed: <span id="rotation-step-value">0.2</span></label>
        <input type="range" id="rotation-step" min="0.05" max="1" step="0.05" value="0.2" style="width: 100%;">
      </div>

      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 3px;">Brightness Sens: <span id="brightness-value">0.2</span></label>
        <input type="range" id="brightness-sensitivity" min="0.1" max="3" step="0.1" value="0.2" style="width: 100%;">
      </div>

      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 3px;">FPS: <span id="fps-value">10</span></label>
        <input type="range" id="fps" min="1" max="60" step="1" value="10" style="width: 100%;">
      </div>
    </div>

    <!-- Debug Screen -->
    <div id="debug-screen" style="position: fixed; bottom: 10px; right: 10px; width: 300px; max-height: 200px; overflow-y: auto; background: rgba(255, 0, 0, 0.9); color: white; padding: 10px; font-family: monospace; font-size: 10px; border-radius: 5px; z-index: 9999; display: none;">
      <div style="font-weight: bold; margin-bottom: 5px;">Errors:</div>
      <div id="debug-content"></div>
    </div>
    <script>
      const debugScreen = document.getElementById('debug-screen');
      const debugContent = document.getElementById('debug-content');

      function logError(message, source, lineno, colno, error) {
        debugScreen.style.display = 'block';
        const errorDiv = document.createElement('div');
        errorDiv.style.borderBottom = '1px solid rgba(255,255,255,0.3)';
        errorDiv.style.marginBottom = '5px';
        errorDiv.style.paddingBottom = '5px';
        errorDiv.innerHTML = `
          <strong>${message}</strong><br>
          ${source ? 'File: ' + source + ':' + lineno : ''}<br>
          ${error ? error.stack : ''}
        `;
        debugContent.appendChild(errorDiv);
      }

      window.onerror = function(message, source, lineno, colno, error) {
        logError(message, source, lineno, colno, error);
        return false;
      };

      window.addEventListener('unhandledrejection', function(event) {
        logError('Promise rejection: ' + event.reason, '', '', '', event.reason);
      });
    </script>

    <script type="module">
      import { commandHandler } from './commands.js';

      // Wait for the command handler to be created
      window.addEventListener('load', () => {
        setTimeout(() => {
          // Get reference to the permutahedron renderer through the window-level commandExecutor
          const getRenderer = () => {
            // Access via global term object
            return window.commandExecutor?.permutahedronRenderer;
          };

          // Store the commandExecutor globally for slider access
          const originalHandler = commandHandler.prototype.constructor;

          // Set up slider event listeners
          const cameraRadiusSlider = document.getElementById('camera-radius');
          const cameraRadiusValue = document.getElementById('camera-radius-value');
          cameraRadiusSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            cameraRadiusValue.textContent = value.toFixed(1);
            const renderer = getRenderer();
            if (renderer) {
              renderer.config.cameraRadius = value;
              renderer.camera.radius = value;
            }
          });

          const cameraFOVSlider = document.getElementById('camera-fov');
          const cameraFOVValue = document.getElementById('camera-fov-value');
          cameraFOVSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            cameraFOVValue.textContent = value;
            const renderer = getRenderer();
            if (renderer) {
              renderer.config.cameraFOV = value;
            }
          });

          const rotationStepSlider = document.getElementById('rotation-step');
          const rotationStepValue = document.getElementById('rotation-step-value');
          rotationStepSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            rotationStepValue.textContent = value.toFixed(2);
            const renderer = getRenderer();
            if (renderer) {
              renderer.config.rotationStep = value;
            }
          });

          const brightnessSensitivitySlider = document.getElementById('brightness-sensitivity');
          const brightnessSensitivityValue = document.getElementById('brightness-value');
          brightnessSensitivitySlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            brightnessSensitivityValue.textContent = value.toFixed(1);
            const renderer = getRenderer();
            if (renderer) {
              renderer.config.brightnessSensitivity = value;
            }
          });

          const fpsSlider = document.getElementById('fps');
          const fpsValue = document.getElementById('fps-value');
          fpsSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            fpsValue.textContent = value;
            const renderer = getRenderer();
            if (renderer) {
              renderer.config.fps = value;
              renderer.frameInterval = 1000 / value;

              // Restart the interval if permutahedron is running
              const commandExecutor = window.commandExecutor;
              if (commandExecutor && commandExecutor.term.permutahedronInterval) {
                clearInterval(commandExecutor.term.permutahedronInterval);

                const renderFrame = () => {
                  const frame = renderer.generateFrame();
                  commandExecutor.term.write('\x1B[H' + frame);
                };

                commandExecutor.term.permutahedronInterval = setInterval(renderFrame, 1000 / value);
              }
            }
          });
        }, 100);
      });
    </script>
  </body>
</html>